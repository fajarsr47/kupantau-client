{# templates/administrasi/presensi/deteksi.html #}
{% extends "administrasi/base.html" %}
{% load static %}
{% block isi %}

<div class="w-full bg-white rounded-2xl p-3 space-y-3">

  {# === Bagian Kamera + Tombol === #}
  <div class="w-full flex flex-col gap-2">
    <video id="videoCam" class="w-full rounded-lg bg-black" autoplay playsinline muted></video>
    <div class="flex gap-2">
      <button id="btnMulai" class="px-3 py-2 bg-sky-300 hover:bg-sky-500 text-white border border-sky-400 rounded-lg text-sm">
        Mulai Deteksi
      </button>
      <button id="btnStop" class="px-3 py-2 bg-rose-300 hover:bg-rose-500 text-white border border-rose-400 rounded-lg text-sm">
        Stop
      </button>
    </div>
  </div>

  {# === Daftar Wajah Terdeteksi (nama + persentase) === #}
  <div class="w-full">
    <div class="text-sm font-semibold text-gray-700 mb-1">Deteksi Saat Ini</div>
    <div id="listDeteksi" class="w-full rounded-lg border border-gray-200 p-2 min-h-14"></div>
  </div>

  {# === Hasil Presensi (sinkronisasi ke NISN) + tombol simpan === #}
  <div class="w-full">
    <div class="text-sm font-semibold text-gray-700 mb-1">Hasil Presensi</div>
    <div id="listPresensi" class="w-full rounded-lg border border-gray-200 p-2 min-h-14"></div>
    <div class="mt-2 flex justify-end">
      <button id="btnSimpanKirim" class="px-4 py-2 bg-blue-300 hover:bg-blue-500 text-white border border-blue-400 rounded-lg text-sm">
        Simpan & Kirim
      </button>
    </div>
  </div>

</div>

{# === JS: tanpa mengubah tampilan; hanya hook ke elemen di atas === #}
<script>
(function(){
  // ID elemen (biarkan apa adanya agar tampilan tidak berubah)
  const elVideo  = document.getElementById('videoCam');
  const btnStart = document.getElementById('btnMulai');
  const btnStop  = document.getElementById('btnStop');
  const boxDet   = document.getElementById('listDeteksi');
  const boxPres  = document.getElementById('listPresensi');
  const btnSave  = document.getElementById('btnSimpanKirim');

  // CSRF (Django)
  function getCookie(name) {
    const v = ('; ' + document.cookie).split('; ' + name + '=');
    if (v.length === 2) return v.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');
  const headers = {'Content-Type':'application/json', 'X-CSRFToken': csrftoken};

  let stream = null, timer = null;
  const presensiMap = new Map(); // nisn -> earliest timestamp ISO

  function renderDeteksi(list){
    if(!list || !list.length){
      boxDet.innerHTML = '<div class="text-sm text-gray-500">Belum ada wajah terdeteksi…</div>';
      return;
    }
    boxDet.innerHTML = list.map(d => `
      <div class="text-sm">
        <span class="font-semibold">${d.label}</span>
        <span class="text-gray-600">(${d.nisn})</span>
        — <span class="text-blue-600">${d.confidence}%</span>
      </div>
    `).join('');
  }

  function renderPresensi(){
    if(presensiMap.size === 0){
      boxPres.innerHTML = '<div class="text-sm text-gray-500">Belum ada data presensi.</div>';
      return;
    }
    const rows = [];
    presensiMap.forEach((ts, nisn)=>{
      const t = new Date(ts);
      rows.push(`<div class="text-sm"><b>${nisn}</b> — Hadir @ <span class="text-green-600">${t.toLocaleString()}</span></div>`);
    });
    boxPres.innerHTML = rows.join('');
  }

  function captureAndSend(){
    if(!elVideo) return;
    const c = document.createElement('canvas');
    c.width = elVideo.videoWidth || 640;
    c.height = elVideo.videoHeight || 480;
    const ctx = c.getContext('2d');
    ctx.drawImage(elVideo, 0, 0, c.width, c.height);
    const dataURL = c.toDataURL('image/jpeg', 0.6);

    fetch("{% url 'deteksi_frame' %}", {
      method: 'POST',
      headers,
      body: JSON.stringify({image: dataURL})
    })
    .then(r => r.json())
    .then(({detected})=>{
      detected = detected || [];
      renderDeteksi(detected);
      // simpan waktu terawal per NISN
      detected.forEach(d=>{
        if(!d.nisn) return;
        if(!presensiMap.has(d.nisn)) presensiMap.set(d.nisn, d.timestamp);
        else {
          const oldTs = new Date(presensiMap.get(d.nisn));
          const newTs = new Date(d.timestamp);
          if(newTs < oldTs) presensiMap.set(d.nisn, d.timestamp);
        }
      });
      renderPresensi();
    })
    .catch(()=>{ /* diamkan agar loop lanjut */ });
  }

  async function start(){
    if(stream) return;
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
      elVideo.srcObject = stream;
      await elVideo.play();
      // kirim frame berkala (atur sesuai kemampuan server)
      timer = setInterval(captureAndSend, 800);
    }catch(e){
      alert('Gagal mengakses kamera: ' + e.message);
    }
  }

  function stop(){
    if(timer){ clearInterval(timer); timer = null; }
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
  }

  function save(){
    if(presensiMap.size === 0){
      alert('Belum ada siswa yang terdeteksi.');
      return;
    }
    const detected = [];
    presensiMap.forEach((ts, nisn)=>detected.push({nisn, timestamp: ts}));

    fetch("{% url 'deteksi_save' %}", {
      method: 'POST',
      headers,
      body: JSON.stringify({detected})
    })
    .then(r=>r.json())
    .then(res=>{
      if(res.ok){
        alert(`Tersimpan. Hadir: ${res.hadir_saved}, Alpha dibuat: ${res.alpha_created}.`);
      }else{
        alert('Gagal menyimpan.');
      }
    })
    .catch(()=>alert('Gagal menyimpan.'));
  }

  btnStart && btnStart.addEventListener('click', start);
  btnStop  && btnStop.addEventListener('click', stop);
  btnSave  && btnSave.addEventListener('click', save);

  // render awal (placeholder)
  renderDeteksi([]);
  renderPresensi();
})();
</script>

{% endblock isi %}
