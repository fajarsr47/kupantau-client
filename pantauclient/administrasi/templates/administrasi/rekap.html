{% extends "administrasi/base.html" %}
{% load static %}
{% block isi %}
    <div class="bg-white p-3 w-full gap-3 grid grid-cols-1 md:grid-cols-2 rounded-xl shadow-md no-print">
        <div class="flex flex-col justify-start">
            <label>Jenis Rekap</label>
            <select class="w-full bg-gray-200 border border-gray-300 text-gray-500 text-sm rounded-lg block p-1.5" disabled>
                <option selected>Rekapitulasi Kehadiran</option>
            </select>
        </div>
        <div class="flex flex-col justify-start">
            <label for="search-student">Cari Siswa</label>
            <input type="text" id="search-student" placeholder="Ketik Nama atau NIS" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-1.5">
        </div>
    </div>

    <div class="bg-white p-3 mt-3 w-full gap-3 grid grid-cols-1 grid-rows-4 md:grid-cols-2 md:grid-rows-3 xl:grid-cols-12 xl:grid-rows-1 rounded-xl shadow-md no-print">
        <div class="flex flex-col justify-start md:col-span-2 xl:col-span-4">
            <label for="start-date">Rentang Waktu</label>
            <div class="flex items-center space-x-2">
                <input type="date" id="start-date" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-1.5">
                <span class="text-gray-500">s/d</span>
                <input type="date" id="end-date" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-1.5">
            </div>
        </div>
        <div class="flex flex-col justify-start xl:col-start-5 xl:col-span-3">
            <label for="scope-selector">Ruang Lingkup</label>
            <select id="scope-selector" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-1.5">
                <option value="semua" selected>Semua Kelas</option>
                <option value="tingkatan">Per Tingkatan</option>
                <option value="kelas">Per Kelas</option>
            </select>
        </div>
        <div class="flex flex-col justify-start xl:col-start-8 xl:col-span-3">
            <div id="tingkatan-container">
                <label for="tingkatan-selector">Tingkatan</label>
                <select id="tingkatan-selector" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-1.5">
                    <option value="7" selected>Tingkat 7</option>
                    <option value="8">Tingkat 8</option>
                    <option value="9">Tingkat 9</option>
                </select>
            </div>
            <div id="kelas-container" class="hidden">
                <label for="kelas-selector">Kelas</label>
                <select id="kelas-selector" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-1.5">
                    {% for kelas in semua_kelas %}
                    <option value="{{ kelas.id }}">{{ kelas.nama_kelas }}</option>
                    {% empty %}
                    <option disabled>Tidak ada kelas</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="flex justify-center items-end md:col-span-2 xl:col-start-11 xl:col-span-2">
            <button id="filter-button" class="w-full h-fit bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 xl:py-1.5 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-filter"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                <span>Tampilkan Rekap</span>
            </button>
        </div>
    </div>

    <div id="hasil-laporan-container" class="bg-white w-full min-h-full h-fit p-4 rounded-xl shadow-md mt-5 flex-col hidden">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 no-print">
            <div>
                <h2 class="text-xl font-semibold text-gray-800">Hasil Laporan</h2>
                <p id="laporan-info" class="text-sm text-gray-500"></p>
            </div>
            <div class="flex space-x-2 mt-4 md:mt-0">
                <button onclick="window.print()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg flex items-center space-x-2 text-sm transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                    <span>Cetak</span>
                </button>
                <button id="export-excel-button" class="bg-green-100 hover:bg-green-200 text-green-700 font-medium py-2 px-4 rounded-lg flex items-center space-x-2 text-sm transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-spreadsheet"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 11h8"/><path d="M8 16h8"/><path d="M11 11v8"/></svg>
                    <span>Ekspor Excel</span>
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="w-12 px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                        <th scope="col" class="w-24 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hari Efektif</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Hadir</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Tidak Hadir</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Persentase</th>
                    </tr>
                </thead>
                <tbody id="rekap-body" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>
{% endblock isi %}

{% block extra_js %}
<style>
@media print {
    body * { visibility: hidden; }
    .no-print, .no-print * { display: none !important; }
    #hasil-laporan-container, #hasil-laporan-container * { visibility: visible; }
    #hasil-laporan-container { position: absolute; left: 0; top: 0; width: 100%; padding: 1rem; box-shadow: none; border: none; margin-top: 0 !important; }
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const exportExcelButton = document.getElementById('export-excel-button');
    
    // Elemen Filter
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const scopeSelector = document.getElementById('scope-selector');
    const tingkatanContainer = document.getElementById('tingkatan-container');
    const tingkatanSelector = document.getElementById('tingkatan-selector');
    const kelasContainer = document.getElementById('kelas-container');
    const kelasSelector = document.getElementById('kelas-selector');
    const filterButton = document.getElementById('filter-button');

    // Elemen Hasil
    const hasilContainer = document.getElementById('hasil-laporan-container');
    const laporanInfo = document.getElementById('laporan-info');
    const rekapBody = document.getElementById('rekap-body');
    const searchInput = document.getElementById('search-student');

    // Set tanggal default (hari ini)
    const today = new Date().toISOString().split('T')[0];
    startDateInput.value = today;
    endDateInput.value = today;

    exportExcelButton.addEventListener('click', function() {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        const scope = scopeSelector.value;
        let scopeValue = '';

        if (scope === 'tingkatan') {
            scopeValue = tingkatanSelector.value;
        } else if (scope === 'kelas') {
            scopeValue = kelasSelector.value;
        }

        if (!startDate || !endDate) {
            alert('Silakan isi rentang tanggal.');
            return;
        }
        
        const url = `{% url 'export_rekap_excel' %}?start_date=${startDate}&end_date=${endDate}&scope=${scope}&scope_value=${scopeValue}`;
        window.location.href = url; // Memicu unduhan file
    });

    function updateDynamicFilters() {
        const scope = scopeSelector.value;
        if (scope === 'semua') {
            tingkatanContainer.classList.remove('hidden');
            tingkatanSelector.disabled = true;
            tingkatanSelector.classList.add('bg-gray-200', 'text-gray-500');
            kelasContainer.classList.add('hidden');
        } else if (scope === 'tingkatan') {
            tingkatanContainer.classList.remove('hidden');
            tingkatanSelector.disabled = false;
            tingkatanSelector.classList.remove('bg-gray-200', 'text-gray-500');
            kelasContainer.classList.add('hidden');
        } else if (scope === 'kelas') {
            tingkatanContainer.classList.add('hidden');
            kelasContainer.classList.remove('hidden');
        }
    }

    scopeSelector.addEventListener('change', updateDynamicFilters);

    function fetchRekap() {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        const scope = scopeSelector.value;
        let scopeValue = '';
        let scopeText = '';

        if (scope === 'semua') {
            scopeText = "Semua Kelas";
        } else if (scope === 'tingkatan') {
            scopeValue = tingkatanSelector.value;
            scopeText = `Tingkat ${scopeValue}`;
        } else if (scope === 'kelas') {
            scopeValue = kelasSelector.value;
            scopeText = kelasSelector.options[kelasSelector.selectedIndex].text;
        }
        
        if (!startDate || !endDate) {
            alert('Silakan isi rentang tanggal.');
            return;
        }

        const url = `{% url 'get_rekap_data' %}?start_date=${startDate}&end_date=${endDate}&scope=${scope}&scope_value=${scopeValue}&jenis_rekap=bulanan`;
        filterButton.disabled = true;
        filterButton.innerHTML = 'Memuat...';
        rekapBody.innerHTML = `<tr><td colspan="8" class="text-center p-6 text-gray-500">Sedang memuat data...</td></tr>`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) throw new Error(data.error);
                updateUI(data, startDate, endDate, scopeText);
            })
            .catch(error => {
                console.error("Fetch error:", error);
                alert('Gagal memuat data rekap.');
                rekapBody.innerHTML = `<tr><td colspan="8" class="text-center p-6 text-red-500">Gagal memuat data.</td></tr>`;
            })
            .finally(() => {
                filterButton.disabled = false;
                filterButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-filter"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg> <span>Tampilkan Rekap</span>`;
            });
    }

    filterButton.addEventListener('click', fetchRekap);
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        const rows = rekapBody.getElementsByTagName('tr');
        for (const row of rows) {
            const nisnCell = row.cells[1];
            const nameCell = row.cells[2];
            if (nisnCell && nameCell) {
                const nisn = nisnCell.textContent.toLowerCase();
                const name = nameCell.textContent.toLowerCase();
                row.style.display = (nisn.includes(query) || name.includes(query)) ? '' : 'none';
            }
        }
    });

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateStr + 'T00:00:00').toLocaleDateString('id-ID', options);
    }
    
    function updateUI(data, startDate, endDate, scopeText) {
        hasilContainer.classList.remove('hidden');
        hasilContainer.classList.add('flex');

        laporanInfo.innerHTML = `Menampilkan rekap untuk <span class="font-bold text-indigo-600">${scopeText}</span> dari tanggal <span class="font-bold">${formatDate(startDate)}</span> hingga <span class="font-bold">${formatDate(endDate)}</span>.`;
        
        rekapBody.innerHTML = '';
        if (data.rekap && data.rekap.length > 0) {
            data.rekap.forEach((item, index) => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-600">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-left text-gray-600">${item.nisn}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-left font-medium text-gray-900">${item.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-left text-gray-600">${item.kelas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-600">${item.hari_efektif}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-600">${item.hadir}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-600">${item.tidak_hadir}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-semibold text-gray-800">${item.persentase}%</td>
                    </tr>
                `;
                rekapBody.innerHTML += row;
            });
        } else {
            rekapBody.innerHTML = `<tr><td colspan="8" class="text-center p-6 text-gray-500">Tidak ada data presensi yang ditemukan untuk filter ini.</td></tr>`;
        }
    }
    
    // Inisialisasi
    updateDynamicFilters();
    fetchRekap();
});
</script>
{% endblock extra_js %}