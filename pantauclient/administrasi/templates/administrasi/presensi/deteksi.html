{% extends "administrasi/presensi/presensi.html" %}
{% load static %}
{% block presensi %}
    <div class="bg-white aspect-square md:aspect-auto p-3 md:col-span-2 md:row-start-2 md:row-span-7 xl:col-span-6 xl:row-start-2 xl:row-span-7 rounded-2xl shadow-sm md:shadow-xl flex flex-col gap-2">
        <video id="videoCam" class="w-full h-[90%] rounded-lg bg-black" autoplay playsinline muted></video>
        <div class="flex w-full h-fit gap-2.5">
            <button id="btnMulai" class="w-full justify-center px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-2xl">
                Mulai Deteksi
            </button>
            <button id="btnStop" class="w-full justify-center px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-2xl">
                Stop
            </button>
        </div>
    </div>
    <div class="hidden md:block bg-white p-4 md:row-start-9 md:row-span-7 xl:row-start-9 xl:col-span-6 xl:row-span-4 rounded-2xl shadow-sm md:shadow-xl">
        <div class="w-full h-3.5 flex flex-row items-center justify-between gap-2">
            <h3 class="whitespace-nowrap">wajah terdeteksi</h3>
            <div class="bg-gray-700 h-1 w-full rounded-full"></div>
        </div>
        <div class="w-full h-full overflow-y-scroll ">
            <table class="mt-2.5 w-full border-collapse overflow-hidden">
                <thead>
                    <tr>
                        <th class="w-12 p-3 text-left border-b-1 border-b-gray-800 font-bold text-black sticky">No</th>
                        <th class="w-full p-3 text-left border-b-1 border-b-gray-800 font-bold text-black sticky">Nama</th>
                        <th class="w-44 p-3 text-left border-b-1 border-b-gray-800 font-bold text-black sticky">Persentase</th>
                    </tr>
                </thead>
                <tbody id="listDeteksi">
                    <tr>
                        <td class="p-3 text-left" colspan="3"><span class="text-sm text-gray-500">Belum ada wajah terdeteksi…</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="bg-white p-4 xl:col-start-7 md:row-start-9 md:col-start-2 md:row-span-7 xl:row-start-2 xl:col-span-9 xl:row-span-11 rounded-2xl shadow-sm md:shadow-xl flex flex-col">
        <div class="w-full h-3.5 flex flex-row items-center justify-between gap-2">
            <h3 class="whitespace-nowrap" >hasil presensi</h3>
            <div class="bg-gray-700 h-1 w-full rounded-full"></div>
        </div>
        <div class="flex-1 overflow-y-scroll">
            <table class="mt-2.5 w-full border-collapse overflow-hidden">
                <thead>
                    <tr>
                        <th class="w-12 p-3 text-left border-b-1 border-b-gray-800 font-bold text-black sticky">No</th>
                        <th class="w-30 p-3 text-left border-b-1 border-b-gray-800 font-bold text-black sticky">NISN</th>
                        <th class="p-3 text-left border-b-1 border-b-gray-800 font-bold text-black sticky">Nama</th>
                        <th class="w-40 p-3 text-left border-b-1 border-b-gray-800 font-bold text-black sticky">Kelas</th>
                    </tr>
                </thead>
                <tbody id="listPresensi">
                    <tr>
                        <td class="p-3 text-left" colspan="4"><span class="text-sm text-gray-500">Belum ada data presensi. Mulai deteksi terlebih dahulu.</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button id="btnSimpanKirim" class="w-full justify-center px-4 py-2 mt-4 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-2xl">
            Simpan dan Kirim
        </button>
    </div>
{% endblock presensi %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    // --- 1. INISIALISASI ID SESUAI KODE ORIGINAL KAMU ---
    const elVideo    = document.getElementById('videoCam');
    const btnStart   = document.getElementById('btnMulai');
    const btnStop    = document.getElementById('btnStop');
    const tbodyDet   = document.getElementById('listDeteksi');
    const tbodyPre   = document.getElementById('listPresensi');
    
    // Konfigurasi Kiosk
    const COOLDOWN_DETIK = 60; 
    let scannedNISNs = {}; // Memori lokal (NISN -> Timestamp)
    
    let stream = null;
    let timer = null;
    let isProcessing = false;

    // --- 2. SETUP TOMBOL ---
    if (btnStart) btnStart.addEventListener('click', startCamera);
    if (btnStop)  btnStop.addEventListener('click', stopCamera);

    // --- 3. FUNGSI KAMERA ---
    async function startCamera() {
        if(stream) return;
        try {
            // Cek permission dulu
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: { ideal: 640 }, height: { ideal: 480 } }, 
                audio: false 
            });
            elVideo.srcObject = stream;
            
            // Tunggu video play baru mulai loop
            elVideo.onloadedmetadata = () => {
                elVideo.play();
                timer = setInterval(captureAndSend, 1000); // Scan tiap 1 detik
            };

            // UI Feedback
            btnStart.disabled = true;
            btnStart.classList.add('opacity-50', 'cursor-not-allowed');
            btnStop.disabled = false;
            btnStop.classList.remove('opacity-50', 'cursor-not-allowed');

        } catch(e) { 
            alert('Gagal akses kamera: ' + e.message + '\nPastikan HTTPS atau Localhost.'); 
        }
    }

    function stopCamera() {
        if(timer) { clearInterval(timer); timer = null; }
        if(stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
        elVideo.srcObject = null;
        
        // Reset UI
        btnStart.disabled = false;
        btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
        btnStop.disabled = true;
        btnStop.classList.add('opacity-50', 'cursor-not-allowed');
    }

    // --- 4. CORE LOGIC: CAPTURE & AUTO-SAVE ---
    function captureAndSend() {
        if (!elVideo || isProcessing) return;
        isProcessing = true;

        // Capture Gambar
        const c = document.createElement('canvas');
        c.width = elVideo.videoWidth;
        c.height = elVideo.videoHeight;
        c.getContext('2d').drawImage(elVideo, 0, 0);
        const dataURL = c.toDataURL('image/jpeg', 0.6);

        // Kirim ke Backend
        fetch("{% url 'deteksi_frame' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', 
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ image: dataURL })
        })
        .then(r => r.json())
        .then(({ detected }) => {
            detected = detected || [];
            
            // A. Update Tabel Kiri (Wajah Terdeteksi)
            updateTableDeteksi(detected);

            // B. Proses Auto-Save (Loop setiap wajah)
            detected.forEach(d => {
                // Hanya proses jika dikenali & ada NISN
                if (d.nisn && d.nama && d.nama !== "Unknown") {
                    handleKioskPresensi(d.nisn, d.nama, d.kelas);
                }
            });
        })
        .catch(err => console.error("Error frame:", err))
        .finally(() => { isProcessing = false; });
    }

    // --- 5. LOGIKA KIOSK (COOLDOWN & SIMPAN) ---
    async function handleKioskPresensi(nisn, nama, kelas) {
        const now = Date.now();
        
        // Cek Cooldown
        if (scannedNISNs[nisn] && (now - scannedNISNs[nisn] < COOLDOWN_DETIK * 1000)) {
            return; // Skip, masih cooldown
        }

        scannedNISNs[nisn] = now; // Kunci

        // 1. Tampilkan Notifikasi & Suara
        playBeep();
        showFloatingNotif(nama);

        // 2. Tambah ke Tabel Kanan (Hasil Presensi)
        addRowToPresensi(nisn, nama, kelas);

        // 3. Simpan ke Database
        try {
            await fetch("{% url 'deteksi_save' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    detected: [{ nisn: nisn, timestamp: new Date().toISOString() }]
                })
            });
            console.log(`Saved: ${nama} (${kelas})`);
        } catch (e) {
            console.error("Gagal simpan:", e);
            delete scannedNISNs[nisn]; // Reset jika gagal
        }
    }

    // --- 6. UPDATE UI TABEL ---
    function updateTableDeteksi(list) {
        if (!list.length) {
            // Jangan hapus jika kosong sebentar agar tidak kedip, atau reset jika lama
            // tbodyDet.innerHTML = `...`; // Opsional
            return;
        }
        tbodyDet.innerHTML = list.map((d, i) => `
            <tr>
                <td class="p-3 text-left">${i + 1}</td>
                <td class="p-3 text-left font-medium">${d.nama || 'Unknown'}</td>
                <td class="p-3 text-left text-sm text-gray-500">${Math.round(d.confidence || 0)}%</td>
            </tr>
        `).join('');
    }

    function addRowToPresensi(nisn, nama, kelas) {
        // Hapus pesan "Belum ada data" jika ada
        if (tbodyPre.querySelector('td[colspan]')) {
            tbodyPre.innerHTML = '';
        }

        const no = tbodyPre.children.length + 1;
        const row = `
            <tr class="bg-green-50 animate-pulse transition-all duration-500">
                <td class="p-3 text-left">${no}</td>
                <td class="p-3 text-left font-mono">${nisn}</td>
                <td class="p-3 text-left font-bold text-green-800">${nama}</td>
                <td class="p-3 text-left font-semibold">${kelas || '-'}</td>
            </tr>
        `;
        // Tambah di paling atas
        tbodyPre.insertAdjacentHTML('afterbegin', row);
    }

    // --- 7. HELPER NOTIFIKASI ---
    function showFloatingNotif(nama) {
        const div = document.createElement('div');
        div.className = "fixed top-10 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-2xl shadow-2xl z-50 font-bold animate-bounce flex items-center gap-2";
        div.innerHTML = `<span>✅</span> <span>Berhasil: ${nama}</span>`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }

    function playBeep() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 1000;
            gain.gain.value = 0.1;
            osc.start();
            setTimeout(() => osc.stop(), 150);
        } catch(e){}
    }
});
</script>
{% endblock extra_js %}