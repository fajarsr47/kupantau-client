{% extends "administrasi/base.html" %}
{% load static %}
{% block isi %}
    <div class="w-full bg-white rounded-2xl flex flex-col p-2.5 gap-3">
        <div class="flex flex-row justify-between gap-3">
            <form id="uploadForm" method="post" enctype="multipart/form-data" class="flex gap-3">
                {% csrf_token %}
                <input type="hidden" name="action" id="actionField" value="preview">
                <input type="file" name="file" id="fileInput" accept=".xlsx,.xls,.csv" class="hidden">

                <button type="button" id="pickBtn" class="w-28 justify-center bg-yellow-100 hover:bg-yellow-200 text-gray-700 border border-yellow-300 rounded-lg flex items-center space-x-2 text-sm transition-colors px-3 py-2">
                    <span>Pilih File</span>
                </button>

                {# TOMBOL SIMPAN: hanya muncul jika sudah preview dan TIDAK ada error baris #}
                {% if preview_rows and not has_row_errors %}
                <button type="submit" onclick="document.getElementById('actionField').value='save'" class="w-28 justify-center bg-blue-300 hover:bg-blue-500 text-white border border-blue-400 rounded-lg flex items-center space-x-2 text-sm transition-colors px-3 py-2">
                    <span>Simpan</span>
                </button>
                {% endif %}
            </form>

            <a href="{% url 'siswa' %}" class="w-24 justify-center bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 rounded-lg flex items-center space-x-2 text-sm transition-colors px-3 py-2">
                <span>Batal</span>
            </a>
        </div>

        {% if errors %}
        <div class="text-red-600 text-sm">
            {% for e in errors %}<div>{{ e }}</div>{% endfor %}
        </div>
        {% endif %}

        {% if preview_rows %}
        <div class="overflow-x-auto min-w-0">
            <table class="min-w-full divide-y divide-gray-200 table-fixed">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIPD</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">JK</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TTL</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ayah</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ibu</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wali</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No Siswa</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No Ortu</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for r in preview_rows %}
                    <tr class="hover:bg-gray-50 {% if r.errors and r.errors|length %}bg-red-50{% endif %}">
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ forloop.counter }}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.nama }}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.nisn }}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.nipd }}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.kelas }}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.jk }}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.tempat_lahir }}{% if r.tanggal_lahir %}, {{ r.tanggal_lahir }}{% endif %}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.nama_ayah }}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.nama_ibu }}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.nama_wali }}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.no_siswa }}</td>
                        <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-600">{{ r.no_ortu }}</td>
                    </tr>
                    {% comment %} {% if r.errors and r.errors|length %}
                    <tr class="bg-red-50">
                        <td colspan="12" class="px-2 pb-3 text-xs text-red-700">
                            Baris {{ r.rownum }}:
                            {% for msg in r.errors %}
                                <span class="inline-block mr-2">â€¢ {{ msg }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %} {% endcomment %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <div class="text-sm text-gray-500">Silakan pilih file (.xlsx / .csv) untuk melihat preview sebelum disimpan.</div>
        {% endif %}
    </div>

    <script>
        const pickBtn = document.getElementById('pickBtn');
        const fileInput = document.getElementById('fileInput');
        const form = document.getElementById('uploadForm');
        pickBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                document.getElementById('actionField').value = 'preview';
                form.submit();
            }
        });
    </script>
{% endblock isi %}
